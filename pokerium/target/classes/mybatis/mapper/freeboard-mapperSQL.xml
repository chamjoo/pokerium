<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="freeboard">

	<select id="selectAllList" parameterType="hashmap" resultType="freeboard">
		SELECT 
			a.NUM				AS		num				,
			a.FBI_IDX 			AS 		fbiIdx			,
			a.MI_ID 			AS		miId			,
			a.FBI_TITLE			AS		fbiTitle		,
			a.FBI_CONTENT 		AS		fbiContent		,
			a.FBI_READCNT		AS		fbiReadcnt		,
			a.FBI_ISVIEW		AS		fbiIsview		,
			a.FBI_REGTIME		AS		fbiRegtime		,
			a.FBI_UPDATETIME	AS		fbiUpdatetime	,
			a.FBI_DELETETIME 	AS		fbiDeletetime	,
			b.MI_NICKNAME 		AS 		miNickname						
		FROM
			(SELECT 
				ROW_NUMBER() OVER(ORDER BY fbi_idx DESC) AS NUM, page_a.* 
			FROM 
				T_FREEBOARD_INFO page_a ,T_MEMBER_INFO page_b	
			WHERE
				page_a.MI_ID = page_b.MI_ID 
				<if test="keyword != null or !keyword.equals('')" >
					<if test="type.equals('title')">
					AND
						page_a.FBI_TITLE LIKE CONCAT('%', #{keyword}, '%') 
					</if>
					<if test="type.equals('id')">
					AND
						page_b.MI_NICKNAME LIKE CONCAT('%', #{keyword}, '%') 
					</if>
				</if>
				) a, T_MEMBER_INFO b	
		WHERE
			a.MI_ID = b.MI_ID 
		AND 
			a.FBI_ISVIEW = 'Y'
		AND						 
			NUM BETWEEN ${startPage} AND ${endPage} 	
		ORDER BY 
			a.fbi_idx
		DESC;
	</select>

	<select id="selectRecordAllCount" parameterType="hashmap" resultType="int">
		SELECT 
			COUNT(*)
		FROM
			T_FREEBOARD_INFO a, T_MEMBER_INFO b
		WHERE 	
			a.MI_ID = b.MI_ID 
		AND 
			a.FBI_ISVIEW = 'Y'
			
		<if test="keyword != null or !keyword.equals('')" >
			<if test="type.equals('title')">
			AND
				a.FBI_TITLE LIKE CONCAT('%', #{keyword}, '%') 
			</if>
			<if test="type.equals('id')">
			AND
				b.MI_NICKNAME LIKE CONCAT('%', #{keyword}, '%') 
			</if>
		</if>
	
	</select>
	
	<select id="fbiRecordAllCount"  resultType="int">
		SELECT 
			COUNT(*)
		FROM
			T_FREEBOARD_INFO a
		WHERE 	
			a.FBI_ISVIEW = 'Y'
			
	
	</select>
	
	
	<insert id="insertFbi" parameterType="hashmap" >
		
		INSERT INTO 
			T_FREEBOARD_INFO
				(MI_ID, FBI_TITLE, FBI_CONTENT)
		VALUES
				(#{member.miId}, #{fbi.fbiTitle}, #{fbi.fbiContent})
	</insert>
	
	<select id="selectFbiView"  resultType="freeboard">
	
		SELECT 
			a.FBI_IDX 			AS 		fbiIdx			,
			a.MI_ID 			AS		miId			,
			a.FBI_TITLE			AS		fbiTitle		,
			a.FBI_CONTENT 		AS		fbiContent		,
			a.FBI_READCNT		AS		fbiReadcnt		,
			a.FBI_ISVIEW		AS		fbiIsview		,
			a.FBI_REGTIME		AS		fbiRegtime		,
			a.FBI_UPDATETIME	AS		fbiUpdatetime	,
			a.FBI_DELETETIME 	AS		fbiDeletetime	,
			b.MI_NICKNAME 		AS 		miNickname		
		FROM
			T_FREEBOARD_INFO a, T_MEMBER_INFO b
		WHERE 	
			a.MI_ID = B.MI_ID 
		AND
			a.FBI_IDX = #{_parameter}
			
	</select>
	
	<update id="updateFbiReadcnt" parameterType="string">
		
		UPDATE 
			T_FREEBOARD_INFO
		SET
			FBI_READCNT = FBI_READCNT + 1
		WHERE 
			FBI_IDX = #{_parameter}
			
	</update>
	
	<update id="updateFbi" parameterType="freeboard">
		
		UPDATE 
			T_FREEBOARD_INFO
		SET
			FBI_TITLE = #{fbiTitle},
			FBI_CONTENT = #{fbiContent},
			FBI_UPDATETIME = NOW()
		WHERE 
			FBI_IDX = #{fbiIdx}
		AND	
			MI_ID = #{miId}
			
	</update>
	
		<update id="deleteFbi" parameterType="freeboard">
		
		UPDATE 
			T_FREEBOARD_INFO
		SET
			FBI_ISVIEW = 'N',
			FBI_DELETETIME = NOW()
		WHERE 
			FBI_IDX = #{fbiIdx}
		AND	
			MI_ID = #{miId}
			
	</update>
</mapper>
